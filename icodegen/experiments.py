# AUTOGENERATED! DO NOT EDIT! File to edit: nbs/02_experiments.ipynb (unless otherwise specified).

__all__ = ['get_mean_probs']

# Cell
import matplotlib.pyplot as plt
plt.style.use('ggplot')

import numpy as np
import tensorflow as tf

from ds4se.mgmnt.prep.i import jsonl_list_to_dataframe, get_dfs
from .model import *
from pathlib import Path
from transformers import GPT2Tokenizer, TFGPT2LMHeadModel

# Cell
# TODO: write test case
def get_mean_probs(df, model):
    counts = [0] * len(model.tokenizer)
    sum_probs = [0.] * len(model.tokenizer)
    for mthd in df.code.values[:100]:
        inputs = model.tokenize(mthd)
        probs = model.get_probs(inputs)[0].numpy()
        for idx, p in zip(inputs['input_ids'][0], probs):
            counts[idx] += 1
            sum_probs[idx] += p[idx]

    counts = np.array(counts)
    sum_probs = np.array(sum_probs)
    return sum_probs / counts